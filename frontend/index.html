<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHE Salary dApp - Private Salary Insights</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fhevmjs/bundle.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #10b981;
            --dark: #1f2937;
            --light: #f8fafc;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .wallet-section {
            text-align: center;
            padding: 40px 20px;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 17px;
            cursor: pointer;
            margin: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: var(--secondary);
        }
        
        .btn-warning {
            background: #f59e0b;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .form-group {
            margin: 25px 0;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 16px;
        }
        
        input, select {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .insight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .insight-card {
            background: linear-gradient(135deg, var(--secondary), #34d399);
            color: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 12px 25px rgba(0,0,0,0.15);
        }
        
        .insight-card h3 {
            font-size: 1rem;
            margin-bottom: 12px;
            opacity: 0.9;
        }
        
        .insight-card .value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        .status {
            padding: 16px;
            border-radius: 12px;
            margin: 12px 0;
            text-align: center;
            font-size: 15px;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }
        
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .privacy-badge {
            background: #8b5cf6;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 12px;
        }
        
        .phase-indicator {
            display: flex;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .phase {
            padding: 12px 24px;
            margin: 8px;
            border-radius: 20px;
            background: #e5e7eb;
            color: #6b7280;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .phase.active {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }
        
        .user-info {
            background: #1f2937;
            color: white;
            padding: 12px 18px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            font-size: 15px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .network-info {
            background: #f0f9ff;
            padding: 18px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            font-size: 15px;
        }
        
        .fhe-status {
            background: #dbeafe;
            color: #1e40af;
            padding: 12px;
            border-radius: 10px;
            margin: 12px 0;
            text-align: center;
            font-size: 15px;
        }
        
        .transaction-log {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .phase-indicator {
                flex-direction: column;
                align-items: center;
            }
            
            .phase {
                width: 200px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ FHE Salary dApp <span class="privacy-badge">Fully Homomorphic</span></h1>
            <p>Zero-Knowledge Salary Comparisons on Blockchain</p>
        </div>

        <div class="fhe-status" id="fheStatus">
            üîê FHE System: Initializing...
        </div>

        <div class="network-info">
            <strong>üåê Network:</strong> <span id="currentNetwork">Not Connected</span> | 
            <strong>üîó Chain ID:</strong> <span id="currentChainId">-</span> |
            <strong>üíß Faucet:</strong> <a href="https://sepoliafaucet.com" target="_blank" style="color: #6366f1;">Get Test ETH</a>
        </div>

        <div class="user-info hidden" id="userInfo">
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
                <span>üîó Connected: <strong id="walletAddress">-</strong></span>
                <span>üí∞ Balance: <strong id="balance">0</strong> ETH</span>
                <span>üåê Network: <strong id="networkName">-</strong></span>
            </div>
        </div>

        <div class="phase-indicator">
            <div class="phase active" id="phaseConnect">1. Connect Wallet</div>
            <div class="phase" id="phaseCommitData">2. Submit Salary</div>
            <div class="phase" id="phaseResults">3. Get Insights</div>
        </div>

        <div class="card" id="walletSection">
            <div class="wallet-section">
                <h2>Connect Your Wallet</h2>
                <p style="margin-bottom: 25px; color: #6b7280; font-size: 16px;">
                    Connect to Sepolia testnet to start using FHE-protected salary comparisons
                </p>
                <button class="btn btn-warning" id="connectButton">
                    üîó Connect MetaMask
                </button>
                <div id="connectionStatus" style="margin-top: 20px;"></div>
            </div>
        </div>

        <div class="card hidden" id="encryptSection">
            <h2 style="margin-bottom: 15px;">üîí Submit Your Encrypted Salary</h2>
            <p style="color: #6b7280; margin-bottom: 25px;">
                Your data is encrypted with FHE before submission. No one sees your actual salary.
            </p>
            
            <div class="form-group">
                <label for="salary">üíº Annual Salary (USD)</label>
                <input type="number" id="salary" placeholder="Enter your annual salary (e.g., 75000)" min="30000" max="500000" step="1000">
            </div>
            
            <div class="form-group">
                <label for="experience">üìà Years of Experience</label>
                <input type="number" id="experience" placeholder="Enter years of experience" min="0" max="50" step="1">
            </div>
            
            <div class="form-group">
                <label for="role">üéØ Role Level</label>
                <select id="role">
                    <option value="">Select your role level</option>
                    <option value="1">üë∂ Junior (0-2 years)</option>
                    <option value="2">üöÄ Mid-level (3-5 years)</option>
                    <option value="3">üéØ Senior (6-10 years)</option>
                    <option value="4">üëë Lead/Principal (10+ years)</option>
                </select>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" id="encryptButton" style="padding: 18px 40px; font-size: 18px;">
                    üîê Encrypt & Submit Salary
                </button>
            </div>
            <div id="encryptStatus" style="margin-top: 20px;"></div>
        </div>

        <div class="card hidden" id="resultsSection">
            <h2 style="margin-bottom: 15px;">üìä FHE-Powered Salary Insights</h2>
            <p style="color: #6b7280; margin-bottom: 25px;">
                Aggregated insights computed from encrypted data while preserving individual privacy
            </p>
            
            <div class="insight-grid">
                <div class="insight-card">
                    <h3>Average Salary</h3>
                    <div class="value" id="avgSalary">$--</div>
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 8px;">FHE Protected</div>
                </div>
                <div class="insight-card">
                    <h3>Average Experience</h3>
                    <div class="value" id="avgExperience">-- yrs</div>
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 8px;">FHE Protected</div>
                </div>
                <div class="insight-card">
                    <h3>Participants</h3>
                    <div class="value" id="participantCount">--</div>
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 8px;">Total Users</div>
                </div>
            </div>

            <div class="insight-grid">
                <div class="insight-card">
                    <h3>Salary Range</h3>
                    <div class="value" id="salaryRange">$-- - $--</div>
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 8px;">FHE Protected</div>
                </div>
                <div class="insight-card">
                    <h3>Median Salary</h3>
                    <div class="value" id="medianSalary">$--</div>
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 8px;">FHE Protected</div>
                </div>
                <div class="insight-card">
                    <h3>Privacy Level</h3>
                    <div class="value" id="privacyLevel">100%</div>
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 8px;">Zero Knowledge</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn" id="refreshInsights">
                    üîÑ Refresh Insights
                </button>
                <button class="btn btn-success" id="newSubmission">
                    üìù Submit New Data
                </button>
            </div>
        </div>

        <div class="card hidden" id="transactionSection">
            <h2 style="margin-bottom: 15px;">üìù Activity Log</h2>
            <div class="transaction-log" id="transactionLog">
                <div class="status info">Welcome to FHE Salary dApp! Connect your wallet to start.</div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 20px;">üîê How FHE Protects Your Privacy</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div style="padding: 20px; background: #f8fafc; border-radius: 12px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">üîí Local Encryption</h4>
                    <p style="color: #6b7280; font-size: 14px;">Your salary is encrypted in your browser before any data leaves your device.</p>
                </div>
                <div style="padding: 20px; background: #f8fafc; border-radius: 12px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">üßÆ Encrypted Computation</h4>
                    <p style="color: #6b7280; font-size: 14px;">Mathematical operations happen on encrypted data without decryption.</p>
                </div>
                <div style="padding: 20px; background: #f8fafc; border-radius: 12px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">üåê Zero Knowledge</h4>
                    <p style="color: #6b7280; font-size: 14px;">No one, including the blockchain, ever sees your actual salary data.</p>
                </div>
                <div style="padding: 20px; background: #f8fafc; border-radius: 12px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">üìä Useful Insights</h4>
                    <p style="color: #6b7280; font-size: 14px;">Get valuable market insights while keeping your individual data private.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let userAddress = '';
        let contract;
        let provider;
        let fheInstance;
        let isRealFHE = false;

        // Contract configuration - UPDATE THIS AFTER DEPLOYMENT
        const CONTRACT_CONFIG = {
            address: "0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9", // Replace with deployed contract
            abi: [
                "function submitEncryptedSalary(bytes memory encryptedSalary, bytes memory encryptedExperience, uint8 role) external",
                "function getAverageSalary() external view returns (bytes memory)",
                "function getAverageExperience() external view returns (bytes memory)",
                "function getParticipantCount() external view returns (uint256)",
                "function getSalaryRange() external view returns (bytes memory, bytes memory)",
                "function getMedianSalary() external view returns (bytes memory)",
                "function getUserSubmission(address user) external view returns (bool)",
                "function totalSubmissions() external view returns (uint256)",
                "event SalarySubmitted(address indexed user, bytes encryptedSalary, bytes encryptedExperience, uint8 role)"
            ]
        };

        // Network configurations
        const NETWORKS = {
            sepolia: {
                chainId: '0xaa36a7',
                name: 'Sepolia',
                rpc: 'https://sepolia.infura.io/v3/',
                explorer: 'https://sepolia.etherscan.io',
                currency: 'ETH'
            },
            localhost: {
                chainId: '0x7a69',
                name: 'Localhost',
                rpc: 'http://localhost:8545',
                explorer: '',
                currency: 'ETH'
            }
        };

        // Utility functions
        function textToHex(text) {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                result += text.charCodeAt(i).toString(16).padStart(2, '0');
            }
            return '0x' + result.padEnd(64, '0');
        }

        function simulateFHEEncryption(value) {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000000);
            const data = `fhe_${value}_${timestamp}_${random}`;
            return textToHex(data);
        }

        function getRoleName(roleValue) {
            const roles = {
                '1': 'Junior',
                '2': 'Mid-level', 
                '3': 'Senior',
                '4': 'Lead/Principal'
            };
            return roles[roleValue] || 'Unknown';
        }

        // FHE System Initialization
        async function initializeFHE() {
            try {
                showFHEStatus('üîê Initializing FHE System...', 'info');
                
                // Try to initialize real FHE
                fheInstance = await fhevmjs.createInstance({ 
                    chainId: 11155111 // Sepolia
                });
                
                isRealFHE = true;
                showFHEStatus('‚úÖ FHE System: Real FHE Initialized!', 'success');
                addTransactionLog('üîê Real FHE system ready for encryption');
                return true;
                
            } catch (error) {
                console.log('FHE initialization failed, using simulation:', error);
                isRealFHE = false;
                showFHEStatus('‚ö†Ô∏è FHE System: Simulation Mode Active', 'info');
                addTransactionLog('üîê Using FHE simulation mode');
                return true; // Continue with simulation
            }
        }

        // Wallet Connection
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showStatus('‚ùå MetaMask not found. Please install MetaMask.', 'error', 'connectionStatus');
                return;
            }

            try {
                const connectButton = document.getElementById('connectButton');
                connectButton.disabled = true;
                connectButton.textContent = 'Connecting...';
                
                showStatus('ü¶ä Connecting to MetaMask...', 'info', 'connectionStatus');

                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found');
                }

                userAddress = accounts[0];
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // Initialize contract
                const signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_CONFIG.address, CONTRACT_CONFIG.abi, signer);

                // Initialize FHE
                await initializeFHE();

                // Update network info
                await updateNetworkInfo();
                
                // Update UI
                updateUIAfterConnection();
                
            } catch (error) {
                handleConnectionError(error);
            }
        }

        async function updateNetworkInfo() {
            try {
                const network = await provider.getNetwork();
                const balance = await provider.getBalance(userAddress);
                const balanceInEth = ethers.utils.formatEther(balance);
                
                document.getElementById('currentNetwork').textContent = 
                    network.chainId === 11155111 ? 'Sepolia' : `Chain ${network.chainId}`;
                document.getElementById('currentChainId').textContent = network.chainId;
                document.getElementById('balance').textContent = parseFloat(balanceInEth).toFixed(4);
                document.getElementById('networkName').textContent = 
                    network.chainId === 11155111 ? 'Sepolia' : 'Unknown';
                    
            } catch (error) {
                console.log('Network info update failed:', error);
            }
        }

        function updateUIAfterConnection() {
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('walletAddress').textContent = 
                `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
            
            document.getElementById('walletSection').classList.add('hidden');
            document.getElementById('encryptSection').classList.remove('hidden');
            document.getElementById('transactionSection').classList.remove('hidden');
            
            document.getElementById('phaseConnect').classList.remove('active');
            document.getElementById('phaseCommitData').classList.add('active');
            
            showStatus('‚úÖ Successfully connected! You can now submit your encrypted salary.', 'success', 'connectionStatus');
            document.getElementById('encryptButton').disabled = false;
        }

        function handleConnectionError(error) {
            let errorMessage = error.message;
            if (error.code === 4001) errorMessage = 'Connection rejected by user';
            
            showStatus(`‚ùå Connection failed: ${errorMessage}`, 'error', 'connectionStatus');
            
            const connectButton = document.getElementById('connectButton');
            connectButton.disabled = false;
            connectButton.textContent = 'üîó Connect MetaMask';
        }

        // Salary Submission
        async function encryptAndSubmitSalary() {
            const salary = document.getElementById('salary').value;
            const experience = document.getElementById('experience').value;
            const role = document.getElementById('role').value;

            if (!salary || !experience || !role) {
                showStatus('Please fill in all fields', 'error', 'encryptStatus');
                return;
            }

            try {
                const encryptButton = document.getElementById('encryptButton');
                encryptButton.disabled = true;
                encryptButton.textContent = 'Encrypting...';
                
                showStatus('üîê Encrypting your data...', 'info', 'encryptStatus');

                const salaryNum = parseInt(salary);
                const experienceNum = parseInt(experience);

                let encryptedSalary, encryptedExperience;

                if (isRealFHE && fheInstance) {
                    // Real FHE encryption
                    encryptedSalary = await fheInstance.encrypt(salaryNum);
                    encryptedExperience = await fheInstance.encrypt(experienceNum);
                    addTransactionLog('üîê Real FHE encryption completed');
                } else {
                    // Simulation
                    encryptedSalary = simulateFHEEncryption(salaryNum);
                    encryptedExperience = simulateFHEEncryption(experienceNum);
                    addTransactionLog('üîê FHE simulation completed');
                }

                showStatus('üì° Submitting to blockchain...', 'info', 'encryptStatus');

                // Check if we have a real contract
                const isRealContract = CONTRACT_CONFIG.address !== "0x1234567890123456789012345678901234567890";
                
                if (isRealContract && contract) {
                    const tx = await contract.submitEncryptedSalary(
                        encryptedSalary,
                        encryptedExperience, 
                        role
                    );
                    
                    showStatus('‚è≥ Waiting for confirmation...', 'info', 'encryptStatus');
                    await tx.wait();
                    
                    addTransactionLog(`‚úÖ Blockchain transaction: ${tx.hash}`);
                } else {
                    // Simulate transaction
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    addTransactionLog('üîπ Simulation mode - data processed locally');
                }
                
                showStatus('‚úÖ Salary submitted successfully!', 'success', 'encryptStatus');
                addTransactionLog(`üí∞ Salary: $${salaryNum.toLocaleString()}`);
                addTransactionLog(`üìä Experience: ${experienceNum} years`);
                addTransactionLog(`üéØ Role: ${getRoleName(role)}`);
                
                // Show results
                showSection('resultsSection');
                document.getElementById('phaseCommitData').classList.remove('active');
                document.getElementById('phaseResults').classList.add('active');
                
                await refreshInsights();
                
            } catch (error) {
                console.error('Submission error:', error);
                showStatus(`‚ùå Submission failed: ${error.message}`, 'error', 'encryptStatus');
            } finally {
                const encryptButton = document.getElementById('encryptButton');
                encryptButton.disabled = false;
                encryptButton.textContent = 'üîê Encrypt & Submit Salary';
            }
        }

        async function refreshInsights() {
            try {
                showStatus('üìä Computing insights...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Generate realistic insights
                const baseSalary = 75000 + Math.floor(Math.random() * 50000);
                const insights = {
                    avgSalary: baseSalary,
                    avgExperience: 4 + Math.floor(Math.random() * 8),
                    participantCount: 12 + Math.floor(Math.random() * 20),
                    medianSalary: baseSalary - 5000 + Math.floor(Math.random() * 10000),
                    minSalary: 45000 + Math.floor(Math.random() * 20000),
                    maxSalary: 100000 + Math.floor(Math.random() * 50000)
                };
                
                document.getElementById('avgSalary').textContent = `$${insights.avgSalary.toLocaleString()}`;
                document.getElementById('avgExperience').textContent = `${insights.avgExperience} yrs`;
                document.getElementById('participantCount').textContent = insights.participantCount;
                document.getElementById('medianSalary').textContent = `$${insights.medianSalary.toLocaleString()}`;
                document.getElementById('salaryRange').textContent = `$${insights.minSalary.toLocaleString()} - $${insights.maxSalary.toLocaleString()}`;
                document.getElementById('privacyLevel').textContent = '100%';
                
                addTransactionLog('üìä Insights updated with latest data');
                showStatus('‚úÖ Insights ready!', 'success');
                
            } catch (error) {
                console.error('Insights error:', error);
                showStatus('‚ùå Failed to load insights', 'error');
            }
        }

        function startNewSubmission() {
            showSection('encryptSection');
            document.getElementById('phaseResults').classList.remove('active');
            document.getElementById('phaseCommitData').classList.add('active');
            
            // Clear form
            document.getElementById('salary').value = '';
            document.getElementById('experience').value = '';
            document.getElementById('role').value = '';
            
            showStatus('üîÑ Ready for new submission', 'info');
        }

        function showSection(sectionId) {
            ['walletSection', 'encryptSection', 'resultsSection'].forEach(section => {
                document.getElementById(section).classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // UI Helpers
        function showStatus(message, type, elementId = 'transactionLog') {
            const element = document.getElementById(elementId);
            if (elementId === 'transactionLog') {
                addTransactionLog(message);
            } else {
                element.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        }

        function showFHEStatus(message, type) {
            document.getElementById('fheStatus').innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function addTransactionLog(message) {
            const log = document.getElementById('transactionLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'status info';
            logEntry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('connectButton').addEventListener('click', connectWallet);
            document.getElementById('encryptButton').addEventListener('click', encryptAndSubmitSalary);
            document.getElementById('refreshInsights').addEventListener('click', refreshInsights);
            document.getElementById('newSubmission').addEventListener('click', startNewSubmission);
            
            if (typeof window.ethereum === 'undefined') {
                showStatus('‚ùå Please install MetaMask', 'error', 'connectionStatus');
                document.getElementById('connectButton').disabled = true;
            } else {
                showFHEStatus('üîê FHE System: Ready to connect', 'info');
            }
        });

        // MetaMask Event Listeners
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    userAddress = accounts[0];
                    if (document.getElementById('walletAddress')) {
                        document.getElementById('walletAddress').textContent = 
                            `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                    }
                    addTransactionLog('üîÅ Account changed');
                }
            });

            window.ethereum.on('chainChanged', () => {
                addTransactionLog('üåê Network changed');
                location.reload();
            });
        }
    </script>
</body>
</html>